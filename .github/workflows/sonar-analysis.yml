name: SonarQube Analysis

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  analyze:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Download SonarScanner
        run: |
          Invoke-WebRequest -Uri "https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006.zip" -OutFile "sonar-scanner.zip"
          Expand-Archive -Path "sonar-scanner.zip" -DestinationPath "."
          echo "C:\actions-runner\_work\PASSWORD-LIS\PASSWORD-LIS\sonar-scanner-5.0.1.3006\bin" | Out-File -FilePath $env:GITHUB_PATH -Append

      - name: Count code files for verification
        run: |
          echo "=== Archivos .cs encontrados ==="
          Get-ChildItem -Path . -Filter *.cs -Recurse | Measure-Object | ForEach-Object { echo "Total: $($_.Count)" }
          echo "=== Archivos .sln encontrados ==="
          Get-ChildItem -Path . -Filter *.sln -Recurse | ForEach-Object { echo "Soluci√≥n: $($_.FullName)" }
          echo "=== Archivos .csproj encontrados ==="
          Get-ChildItem -Path . -Filter *.csproj -Recurse | ForEach-Object { echo "Proyecto: $($_.FullName)" }
      - name: Create SonarQube properties file
        run: |
          $propertiesContent = @"
          sonar.projectKey=password-game
          sonar.projectName=PASSWORD LIS
          sonar.host.url=http://localhost:9000
          sonar.token=${{ secrets.SONAR_TOKEN }}
          sonar.sources=.
          sonar.sourceEncoding=UTF-8
          sonar.inclusions=**/*.cs,**/*.vb,**/*.fs
          sonar.exclusions=**/node_modules/**,**/*.min.js,**/packages/**,**/bin/**,**/obj/**
          sonar.coverage.exclusions=**/*
          sonar.cpd.exclusions=**/*
          sonar.scm.disabled=true
          "@
          $propertiesContent | Out-File -FilePath "sonar-project.properties" -Encoding UTF8

      - name: Run SonarScanner
        run: sonar-scanner