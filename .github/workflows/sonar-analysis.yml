name: SonarQube Code Analysis Only

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  analyze:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: List all projects for analysis
        run: |
          echo "=== Proyectos que ser√°n analizados ==="
          Get-ChildItem -Path . -Filter *.csproj -Recurse | ForEach-Object { 
            echo " - $($_.FullName)" 
          }

      - name: Run SonarQube Analysis
        run: |
          dotnet-sonarscanner begin /k:"password-game" `
            /d:sonar.host.url="http://localhost:9000" `
            /d:sonar.login="${{ secrets.SONAR_TOKEN }}" `
            /d:sonar.scm.disabled=true `
            /d:sonar.sourceEncoding=UTF-8 `
            /d:sonar.coverage.exclusions=**/* `
            /d:sonar.cpd.exclusions=**/* `
            /d:sonar.scm.provider=git

      - name: Fake build step (required by SonarScanner)
        run: echo "Analysis only - no compilation needed"

      - name: End SonarQube Scan
        run: |
          dotnet-sonarscanner end /d:sonar.login="${{ secrets.SONAR_TOKEN }}"
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}