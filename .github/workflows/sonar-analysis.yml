name: SonarQube C# Analysis

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-scan:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Explore project structure
        run: |
          echo "=== Current directory ==="
          pwd
          echo "=== All files and folders ==="
          Get-ChildItem -Recurse | Where-Object { $_.Name -like "*.sln" -or $_.Name -like "*.csproj" } | ForEach-Object { echo "Found: $($_.FullName)" }
          echo "=== Top level contents ==="
          Get-ChildItem

      - name: Begin SonarQube Scan
        run: |
          dotnet-sonarscanner begin /k:"password-game" `
            /d:sonar.host.url="http://localhost:9000" `
            /d:sonar.login="${{ secrets.SONAR_TOKEN }}"
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Build all projects recursively
        run: |
          # Buscar y construir cualquier .sln o .csproj
          $slnFiles = Get-ChildItem -Path . -Filter *.sln -Recurse
          $csprojFiles = Get-ChildItem -Path . -Filter *.csproj -Recurse
          
          if ($slnFiles) {
            $slnFiles | ForEach-Object {
              echo "Building solution: $($_.Name)"
              dotnet build $_.FullName --configuration Release
            }
          } elseif ($csprojFiles) {
            $csprojFiles | ForEach-Object {
              echo "Building project: $($_.Name)"
              dotnet build $_.FullName --configuration Release
            }
          } else {
            echo "No .sln or .csproj files found"
            exit 1
          }

      - name: End SonarQube Scan
        run: |
          dotnet-sonarscanner end /d:sonar.login="${{ secrets.SONAR_TOKEN }}"
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}